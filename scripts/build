#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

PROJECT="Reader.xcodeproj"
SCHEME="ReaderApp"
CONFIGURATION="Debug"
DERIVED_DATA="$ROOT_DIR/.build/DerivedData"
DESTINATION="generic/platform=iOS Simulator"

# Parse arguments
SANITIZER=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --sanitizer=*)
      SANITIZER="${1#*=}"
      shift
      ;;
    --sanitizer)
      SANITIZER="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: $0 [--sanitizer=asan|tsan|ubsan]"
      echo ""
      echo "Options:"
      echo "  --sanitizer=asan    Enable Address Sanitizer (memory errors, leaks)"
      echo "  --sanitizer=tsan    Enable Thread Sanitizer (data races)"
      echo "  --sanitizer=ubsan   Enable Undefined Behavior Sanitizer"
      echo ""
      echo "Note: ASan and TSan cannot be enabled simultaneously."
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Build sanitizer arguments
SANITIZER_ARGS=()
case "$SANITIZER" in
  asan|address)
    echo "Building with Address Sanitizer enabled"
    SANITIZER_ARGS+=(-enableAddressSanitizer YES)
    ;;
  tsan|thread)
    echo "Building with Thread Sanitizer enabled"
    SANITIZER_ARGS+=(-enableThreadSanitizer YES)
    ;;
  ubsan|undefined)
    echo "Building with Undefined Behavior Sanitizer enabled"
    SANITIZER_ARGS+=(-enableUndefinedBehaviorSanitizer YES)
    ;;
  "")
    # No sanitizer
    ;;
  *)
    echo "Unknown sanitizer: $SANITIZER" >&2
    echo "Valid options: asan, tsan, ubsan" >&2
    exit 1
    ;;
esac

if [ ! -d "$PROJECT" ]; then
  echo "$PROJECT not found. Run ./scripts/bootstrap first." >&2
  exit 1
fi

# Ensure embedding model exists (required for semantic search)
ML_MODEL_PATH="$ROOT_DIR/App/Resources/bge-small-en.mlpackage"
if [ ! -d "$ML_MODEL_PATH" ]; then
  echo "Embedding model missing. Generating..."
  uv run --with transformers --with torch --with coremltools \
    python "$ROOT_DIR/scripts/convert_bge_to_coreml.py"
fi

xcodebuild \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -configuration "$CONFIGURATION" \
  -destination "$DESTINATION" \
  -derivedDataPath "$DERIVED_DATA" \
  "${SANITIZER_ARGS[@]}" \
  build
