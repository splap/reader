#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

PROJECT="Reader.xcodeproj"
SCHEME="ReaderApp"
CONFIGURATION="Debug"
DERIVED_DATA="$ROOT_DIR/.build/DerivedData"
DESTINATION="generic/platform=iOS Simulator"

if [ ! -d "$PROJECT" ]; then
  echo "$PROJECT not found. Run ./scripts/bootstrap first." >&2
  exit 1
fi

# Ensure embedding model exists (required for semantic search)
ML_MODEL_PATH="$ROOT_DIR/App/Resources/bge-small-en.mlpackage"
if [ ! -d "$ML_MODEL_PATH" ]; then
  echo "Embedding model missing. Generating..."
  uv run --with transformers --with torch --with coremltools \
    python "$ROOT_DIR/scripts/convert_bge_to_coreml.py"
fi

xcodebuild \
  -project "$PROJECT" \
  -scheme "$SCHEME" \
  -configuration "$CONFIGURATION" \
  -destination "$DESTINATION" \
  -derivedDataPath "$DERIVED_DATA" \
  build
