#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

PROJECT="Reader.xcodeproj"
CONFIGURATION="Debug"
DERIVED_DATA="$ROOT_DIR/.build/DerivedData"

# Use simulator-uuid if available, otherwise fall back to name-based destination
if [ -f "$ROOT_DIR/simulator-uuid" ]; then
  UDID=$(cat "$ROOT_DIR/simulator-uuid")
  DESTINATION="platform=iOS Simulator,id=$UDID"
else
  DESTINATION="platform=iOS Simulator,name=iPad Pro 11-inch (M5),OS=26.0.1,arch=arm64"
fi
EXTRA_BUILD_SETTINGS=""

# Parse test type argument: unit (default), ui, all, or perf
TEST_TYPE="${1:-unit}"

if [ "${UPDATE_SNAPSHOTS:-}" = "1" ]; then
  EXTRA_BUILD_SETTINGS="SWIFT_ACTIVE_COMPILATION_CONDITIONS=DEBUG SNAPSHOT_RECORD"
fi

if [ ! -d "$PROJECT" ]; then
  echo "$PROJECT not found. Run ./scripts/bootstrap first." >&2
  exit 1
fi

run_tests() {
  local scheme="$1"
  local test_filter="${2:-}"
  echo "Running tests for scheme: $scheme"

  local xcodebuild_args=(
    -project "$PROJECT"
    -scheme "$scheme"
    -configuration "$CONFIGURATION"
    -destination "$DESTINATION"
    -derivedDataPath "$DERIVED_DATA"
  )

  if [ -n "$EXTRA_BUILD_SETTINGS" ]; then
    xcodebuild_args+=("$EXTRA_BUILD_SETTINGS")
  fi

  if [ -n "$test_filter" ]; then
    xcodebuild_args+=(-only-testing:"$test_filter")
  fi

  xcodebuild_args+=(test)

  xcodebuild "${xcodebuild_args[@]}"
}

case "$TEST_TYPE" in
  unit)
    run_tests "ReaderApp"
    ;;
  ui)
    run_tests "ReaderAppUITests"
    ;;
  all)
    run_tests "ReaderApp"
    echo ""
    run_tests "ReaderAppUITests"
    ;;
  help|-h|--help)
    echo "Usage: $0 [unit|ui|all|--list|<test-pattern>|ui:<test-pattern>]" >&2
    echo "  unit (default): Run unit and snapshot tests" >&2
    echo "  ui: Run UI tests only" >&2
    echo "  all: Run all tests" >&2
    echo "  --list: List all available tests" >&2
    echo "  <test-pattern>: Run matching unit test (e.g., testPositionStoreRoundTrip, VectorStoreTests)" >&2
    echo "  ui:<test-pattern>: Run matching UI test (e.g., ui:testScrubberAppearsOnTap)" >&2
    exit 0
    ;;
  --list|list)
    echo "Unit tests:"
    grep -rh "func test[A-Za-z0-9_]*" \
      "$ROOT_DIR/Packages/ReaderKit/Tests/ReaderCoreTests" \
      "$ROOT_DIR/Packages/ReaderKit/Tests/ReaderUITests" \
      "$ROOT_DIR/App/Tests" 2>/dev/null \
      | grep -o "func test[A-Za-z0-9_]*" \
      | sed 's/func /  /' \
      | sort -u

    echo ""
    echo "UI tests (use ui: prefix):"
    grep -rh "func test[A-Za-z0-9_]*" "$ROOT_DIR/App/UITests" 2>/dev/null \
      | grep -o "func test[A-Za-z0-9_]*" \
      | sed 's/func /  ui:/' \
      | sort -u
    exit 0
    ;;
  ui:*)
    # UI test with prefix syntax: ui:testFoo
    TEST_NAME="${TEST_TYPE#ui:}"
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/$TEST_NAME"
    ;;
  *)
    # Default: treat as unit test pattern
    # Search for matching test in unit test directories
    PATTERN="$TEST_TYPE"

    # Check if it looks like a UI test
    if grep -rq "func $PATTERN\|class $PATTERN" "$ROOT_DIR/App/UITests" 2>/dev/null; then
      echo "Note: '$PATTERN' looks like a UI test. Use 'ui:$PATTERN' to run it." >&2
      exit 1
    fi

    # Search unit test directories for the pattern
    UNIT_TEST_DIRS=(
      "Packages/ReaderKit/Tests/ReaderCoreTests:ReaderCoreUnitTests"
      "Packages/ReaderKit/Tests/ReaderUITests:ReaderUISnapshotTests"
      "App/Tests:ReaderAppTests"
    )

    FOUND_BUNDLE=""
    FOUND_CLASS=""

    for entry in "${UNIT_TEST_DIRS[@]}"; do
      DIR="${entry%:*}"
      BUNDLE="${entry#*:}"

      # Look for test method: func testFoo
      MATCH=$(grep -rl "func $PATTERN" "$ROOT_DIR/$DIR" 2>/dev/null | head -1 || true)
      if [ -n "$MATCH" ]; then
        FOUND_BUNDLE="$BUNDLE"
        # Find line number of test, then find the class it belongs to
        TEST_LINE=$(grep -n "func $PATTERN" "$MATCH" | head -1 | cut -d: -f1)
        # Find the most recent class declaration before this line
        FOUND_CLASS=$(head -n "$TEST_LINE" "$MATCH" | grep -o "class [A-Za-z0-9_]*" | tail -1 | cut -d' ' -f2)
        break
      fi

      # Look for test class: class FooTests
      MATCH=$(grep -rl "class $PATTERN" "$ROOT_DIR/$DIR" 2>/dev/null | head -1 || true)
      if [ -n "$MATCH" ]; then
        FOUND_BUNDLE="$BUNDLE"
        FOUND_CLASS="$PATTERN"
        PATTERN=""  # Running whole class, not a specific test
        break
      fi
    done

    if [ -z "$FOUND_BUNDLE" ]; then
      echo "Error: Could not find test matching '$TEST_TYPE'" >&2
      echo "Searched in: ReaderCoreTests, ReaderUITests, AppTests" >&2
      exit 1
    fi

    if [ -n "$PATTERN" ]; then
      # Specific test method
      TEST_FILTER="$FOUND_BUNDLE/$FOUND_CLASS/$PATTERN"
    else
      # Whole test class
      TEST_FILTER="$FOUND_BUNDLE/$FOUND_CLASS"
    fi

    echo "Found: $TEST_FILTER"
    run_tests "ReaderApp" "$TEST_FILTER"
    ;;
esac
