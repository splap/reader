#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

PROJECT="Reader.xcodeproj"
CONFIGURATION="Debug"
DESTINATION="platform=iOS Simulator,name=iPad Pro 11-inch (M4),OS=18.5,arch=arm64"
DERIVED_DATA="$ROOT_DIR/.build/DerivedData"
EXTRA_BUILD_SETTINGS=""

# Parse test type argument: unit (default), ui, or all
TEST_TYPE="${1:-unit}"

if [ "${UPDATE_SNAPSHOTS:-}" = "1" ]; then
  EXTRA_BUILD_SETTINGS="SWIFT_ACTIVE_COMPILATION_CONDITIONS=DEBUG SNAPSHOT_RECORD"
fi

if [ ! -d "$PROJECT" ]; then
  echo "$PROJECT not found. Run ./scripts/bootstrap first." >&2
  exit 1
fi

run_tests() {
  local scheme="$1"
  echo "Running tests for scheme: $scheme"

  if [ -n "$EXTRA_BUILD_SETTINGS" ]; then
    xcodebuild \
      -project "$PROJECT" \
      -scheme "$scheme" \
      -configuration "$CONFIGURATION" \
      -destination "$DESTINATION" \
      -derivedDataPath "$DERIVED_DATA" \
      "$EXTRA_BUILD_SETTINGS" \
      test
  else
    xcodebuild \
      -project "$PROJECT" \
      -scheme "$scheme" \
      -configuration "$CONFIGURATION" \
      -destination "$DESTINATION" \
      -derivedDataPath "$DERIVED_DATA" \
      test
  fi
}

case "$TEST_TYPE" in
  unit)
    run_tests "ReaderApp"
    ;;
  ui)
    run_tests "ReaderAppUITests"
    ;;
  all)
    run_tests "ReaderApp"
    echo ""
    run_tests "ReaderAppUITests"
    ;;
  *)
    echo "Usage: $0 [unit|ui|all]" >&2
    echo "  unit (default): Run unit and snapshot tests" >&2
    echo "  ui: Run UI tests only" >&2
    echo "  all: Run all tests" >&2
    exit 1
    ;;
esac
