#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

PROJECT="Reader.xcodeproj"
CONFIGURATION="Debug"
DERIVED_DATA="$ROOT_DIR/.build/DerivedData"

# Use simulator-uuid if available, otherwise fall back to name-based destination
if [ -f "$ROOT_DIR/simulator-uuid" ]; then
  UDID=$(cat "$ROOT_DIR/simulator-uuid")
  DESTINATION="platform=iOS Simulator,id=$UDID"
else
  DESTINATION="platform=iOS Simulator,name=iPad Pro 11-inch (M4),OS=26.0.1,arch=arm64"
fi
EXTRA_BUILD_SETTINGS=""

# Parse test type argument: unit (default), ui, all, or perf
TEST_TYPE="${1:-unit}"

if [ "${UPDATE_SNAPSHOTS:-}" = "1" ]; then
  EXTRA_BUILD_SETTINGS="SWIFT_ACTIVE_COMPILATION_CONDITIONS=DEBUG SNAPSHOT_RECORD"
fi

if [ ! -d "$PROJECT" ]; then
  echo "$PROJECT not found. Run ./scripts/bootstrap first." >&2
  exit 1
fi

run_tests() {
  local scheme="$1"
  local test_filter="${2:-}"
  echo "Running tests for scheme: $scheme"

  local xcodebuild_args=(
    -project "$PROJECT"
    -scheme "$scheme"
    -configuration "$CONFIGURATION"
    -destination "$DESTINATION"
    -derivedDataPath "$DERIVED_DATA"
  )

  if [ -n "$EXTRA_BUILD_SETTINGS" ]; then
    xcodebuild_args+=("$EXTRA_BUILD_SETTINGS")
  fi

  if [ -n "$test_filter" ]; then
    xcodebuild_args+=(-only-testing:"$test_filter")
  fi

  xcodebuild_args+=(test)

  xcodebuild "${xcodebuild_args[@]}"
}

case "$TEST_TYPE" in
  unit)
    run_tests "ReaderApp"
    ;;
  ui)
    run_tests "ReaderAppUITests"
    ;;
  all)
    run_tests "ReaderApp"
    echo ""
    run_tests "ReaderAppUITests"
    ;;
  perf)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testTextResizeReflowPerformance"
    ;;
  textsize)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testTextSizeChangeAffectsPageCount"
    ;;
  alignment)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testMarginAndPageBleed"
    ;;
  scrubber)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testScrubberAppearsOnTap"
    ;;
  position)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testPositionPersistence"
    ;;
  doubletap)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testDoubleTapDoesNotMisalignPage"
    ;;
  vectorindex)
    run_tests "ReaderAppUITests" "ReaderAppUITests/ReaderAppUITests/testVectorIndexBuildingOnBookOpen"
    ;;
  settings)
    run_tests "ReaderApp" "ReaderAppUITests/ReaderAppUITests/testNavigateFromLibraryToSettings"
    ;;
  maxread)
    run_tests "ReaderApp" "ReaderAppUITests/ReaderAppUITests/testMaxReadExtentIndicator"
    ;;
  *)
    echo "Usage: $0 [unit|ui|all|perf|textsize|alignment|scrubber|position|doubletap|vectorindex|settings|maxread]" >&2
    echo "  unit (default): Run unit and snapshot tests" >&2
    echo "  ui: Run UI tests only" >&2
    echo "  all: Run all tests" >&2
    echo "  perf: Run text resize reflow performance test" >&2
    echo "  textsize: Run text size change page count test" >&2
    echo "  alignment: Run margin and page bleed test" >&2
    echo "  scrubber: Run scrubber overlay toggle test" >&2
    echo "  position: Run position persistence test" >&2
    echo "  doubletap: Run double-tap alignment test" >&2
    echo "  vectorindex: Run vector index building integration test" >&2
    echo "  settings: Run settings navigation test" >&2
    echo "  maxread: Run max read extent indicator test" >&2
    exit 1
    ;;
esac
