#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

# Use simulator by default, set USE_SIMULATOR=0 to use physical device
USE_SIMULATOR="${USE_SIMULATOR:-1}"

if [ "$USE_SIMULATOR" = "1" ]; then
  echo "Running on simulator..."
  DEVICE_NAME="iPad Pro 11-inch (M4)"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphonesimulator"

  # First check if any simulator is already booted
  DEVICE_UDID=$(xcrun simctl list devices | grep "(Booted)" | head -1 | \
    grep -o "[0-9A-F]\{8\}-[0-9A-F]\{4\}-[0-9A-F]\{4\}-[0-9A-F]\{4\}-[0-9A-F]\{12\}")

  if [ -n "$DEVICE_UDID" ]; then
    echo "Using already-booted simulator: $DEVICE_UDID"
  else
    # No simulator booted, find and boot iOS 26 iPad Pro 11-inch M4
    DEVICE_UDID=$(python3 - <<'PY'
import json
import subprocess
import sys

name = "iPad Pro 11-inch (M4)"

raw = subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"])
obj = json.loads(raw)
# Look for iOS 26 runtime
for runtime, devices in obj.get("devices", {}).items():
    if "iOS-26" in runtime or "iOS-18-2" in runtime:
        for device in devices:
            if device.get("name") == name:
                print(device.get("udid", ""))
                sys.exit(0)

sys.exit(1)
PY
)

    if [ -z "$DEVICE_UDID" ]; then
      echo "Simulator device not found for $DEVICE_NAME with iOS 26." >&2
      exit 1
    fi

    echo "Booting simulator: $DEVICE_UDID"
    xcrun simctl boot "$DEVICE_UDID" || true
    xcrun simctl bootstatus "$DEVICE_UDID" -b
  fi
else
  echo "Running on physical iPad..."
  DEVICE_UDID="00008027-0009043A2687002E"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphoneos"
fi

# Build the app
echo "Building for $SDK..."
if [ "$USE_SIMULATOR" = "1" ]; then
  PLATFORM="iOS Simulator"
else
  PLATFORM="iOS"
fi

xcodebuild \
  -scheme ReaderApp \
  -destination "platform=$PLATFORM,id=$DEVICE_UDID" \
  -allowProvisioningUpdates \
  -quiet \
  build

APP_PATH="$HOME/Library/Developer/Xcode/DerivedData/Reader-bbwykgehugzyzdamvzcflakzkgju/Build/Products/Debug-$SDK/ReaderApp.app"

if [ ! -d "$APP_PATH" ]; then
  echo "App not found at $APP_PATH. Build failed?" >&2
  exit 1
fi

echo "Installing app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl install "$DEVICE_UDID" "$APP_PATH"
else
  xcrun devicectl device install app --device "$DEVICE_UDID" "$APP_PATH" 2>&1 | grep -v "acquired" || true
fi

echo "Launching app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl launch "$DEVICE_UDID" "$APP_BUNDLE_ID"
else
  xcrun devicectl device process launch --device "$DEVICE_UDID" "$APP_BUNDLE_ID" --console
fi
