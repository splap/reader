#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

# Parse arguments
CLEAN_DATA=0
SCREENSHOT_MODE=0
SCREENSHOT_BOOK=""
SCREENSHOT_CHAPTER=""
SCREENSHOT_CFI=""
SCREENSHOT_OUTPUT=""
SCREENSHOT_RENDERER=""
SCREENSHOT_FONT_SCALE=""

for arg in "$@"; do
  case "$arg" in
    --clean)
      CLEAN_DATA=1
      ;;
    --screenshot)
      SCREENSHOT_MODE=1
      ;;
    --book=*)
      SCREENSHOT_BOOK="${arg#--book=}"
      ;;
    --chapter=*)
      SCREENSHOT_CHAPTER="${arg#--chapter=}"
      ;;
    --cfi=*)
      SCREENSHOT_CFI="${arg#--cfi=}"
      ;;
    --output=*)
      SCREENSHOT_OUTPUT="${arg#--output=}"
      ;;
    --renderer=*)
      SCREENSHOT_RENDERER="${arg#--renderer=}"
      ;;
    --font-scale=*)
      SCREENSHOT_FONT_SCALE="${arg#--font-scale=}"
      ;;
  esac
done

# Load local environment from .env if it exists
if [ -f "$ROOT_DIR/.env" ]; then
  set -a
  source "$ROOT_DIR/.env"
  set +a
fi

# Use simulator by default, set USE_SIMULATOR=0 to use physical device
USE_SIMULATOR="${USE_SIMULATOR:-1}"

if [ "$USE_SIMULATOR" = "1" ]; then
  echo "Running on simulator..."
  DEVICE_NAME="iPad Pro 11-inch (M5)"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphonesimulator"

  # Check claim ticket first - don't steal another agent's simulator
  CLAIM_FILE="$ROOT_DIR/simulator-uuid"
  if [ -f "$CLAIM_FILE" ]; then
    DEVICE_UDID=$(cat "$CLAIM_FILE")
    STATE=$(xcrun simctl list devices -j | jq -r --arg udid "$DEVICE_UDID" \
      '.devices | to_entries[] | .value[] | select(.udid == $udid) | .state' | head -1)
    [ -z "$STATE" ] && STATE="NotFound"

    if [ "$STATE" = "Booted" ]; then
      echo "Using our simulator: $DEVICE_UDID"
    elif [ "$STATE" = "Shutdown" ]; then
      echo "Booting our simulator: $DEVICE_UDID"
      xcrun simctl boot "$DEVICE_UDID" || true
      xcrun simctl bootstatus "$DEVICE_UDID" -b
    else
      echo "Claimed simulator $DEVICE_UDID not found, rm simulator-uuid and re run to create a new one."
    fi
  fi

  # If no valid claim, boot a new (non-booted) simulator
  if [ ! -f "$CLAIM_FILE" ]; then
    DEVICE_UDID=$(xcrun simctl list devices available -j | jq -r '
      .devices | to_entries[] |
      select(.key | test("iOS-26|iOS-18-2")) |
      .value[] |
      select(.name == "iPad Pro 11-inch (M5)" and .state == "Shutdown") |
      .udid' | head -1)

    if [ -z "$DEVICE_UDID" ]; then
      echo "No available (shutdown) simulator for $DEVICE_NAME. All may be in use." >&2
      exit 1
    fi

    echo "Booting new simulator: $DEVICE_UDID"
    xcrun simctl boot "$DEVICE_UDID" || true
    xcrun simctl bootstatus "$DEVICE_UDID" -b
    echo "$DEVICE_UDID" > "$CLAIM_FILE"
  fi
else
  echo "Running on physical iPad..."
  # Find first connected iOS device using JSON for reliable UDID extraction
  DEVICES_JSON=$(mktemp)
  xcrun devicectl list devices -j "$DEVICES_JSON" 2>/dev/null
  DEVICE_UDID=$(jq -r '
    .result.devices[] |
    select(.connectionProperties.tunnelState == "connected") |
    .hardwareProperties.udid
  ' "$DEVICES_JSON" | head -1)
  DEVICE_NAME=$(jq -r '
    .result.devices[] |
    select(.connectionProperties.tunnelState == "connected") |
    .deviceProperties.name
  ' "$DEVICES_JSON" | head -1)
  rm -f "$DEVICES_JSON"

  if [ -z "$DEVICE_UDID" ]; then
    echo "No connected physical device found." >&2
    echo "Available devices:" >&2
    xcrun devicectl list devices 2>/dev/null | grep -E "iPad|iPhone" >&2
    exit 1
  fi
  echo "Using device: $DEVICE_NAME ($DEVICE_UDID)"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphoneos"
fi

# Clean app data if requested
if [ "$CLEAN_DATA" = "1" ]; then
  if [ "$USE_SIMULATOR" = "1" ]; then
    echo "Cleaning app data from simulator..."
    APP_CONTAINER=$(xcrun simctl get_app_container "$DEVICE_UDID" "$APP_BUNDLE_ID" data 2>/dev/null || true)
    if [ -n "$APP_CONTAINER" ]; then
      # Clear Application Support (page layouts, vector indices, chunk store, etc.)
      SUPPORT_DIR="$APP_CONTAINER/Library/Application Support/com.splap.reader"
      if [ -d "$SUPPORT_DIR" ]; then
        echo "  Removing: $SUPPORT_DIR"
        rm -rf "$SUPPORT_DIR"
      fi
      # Clear Documents (any cached content)
      DOCS_DIR="$APP_CONTAINER/Documents"
      if [ -d "$DOCS_DIR" ]; then
        echo "  Clearing Documents folder..."
        rm -rf "$DOCS_DIR"/*
      fi
      echo "App data cleaned."
    else
      echo "No app container found (app not installed yet)"
    fi
  else
    echo "Warning: --clean only supported for simulator"
  fi
fi

# Ensure embedding model exists (required for semantic search)
ML_MODEL_PATH="$ROOT_DIR/App/Resources/bge-small-en.mlpackage"
if [ ! -d "$ML_MODEL_PATH" ]; then
  echo "Embedding model missing. Generating..."
  uv run --with transformers --with torch --with coremltools \
    python "$ROOT_DIR/scripts/convert_bge_to_coreml.py"
fi

# Build the app
echo "Building for $SDK..."
if [ "$USE_SIMULATOR" = "1" ]; then
  PLATFORM="iOS Simulator"
else
  PLATFORM="iOS"
fi

DERIVED_DATA="$ROOT_DIR/.build/DerivedData"

xcodebuild \
  -scheme ReaderApp \
  -destination "platform=$PLATFORM,id=$DEVICE_UDID" \
  -derivedDataPath "$DERIVED_DATA" \
  -allowProvisioningUpdates \
  -quiet \
  build

APP_PATH="$DERIVED_DATA/Build/Products/Debug-$SDK/ReaderApp.app"

if [ ! -d "$APP_PATH" ]; then
  echo "App not found at $APP_PATH. Build failed?" >&2
  exit 1
fi

echo "Installing app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

  # Load test books if available (set TEST_BOOKS_DIR in .env or environment)
  BOOKS_SOURCE="${TEST_BOOKS_DIR:-}"
  if [ -n "$BOOKS_SOURCE" ] && [ -d "$BOOKS_SOURCE" ]; then
    echo "Loading test books..."
    APP_CONTAINER=$(xcrun simctl get_app_container "$DEVICE_UDID" "$APP_BUNDLE_ID" data 2>/dev/null || true)
    if [ -n "$APP_CONTAINER" ]; then
      BOOKS_DIR="$APP_CONTAINER/Documents/TestBooks"
      mkdir -p "$BOOKS_DIR"
      cp "$BOOKS_SOURCE"/*.epub "$BOOKS_DIR/" 2>/dev/null || true
      BOOK_COUNT=$(ls "$BOOKS_DIR"/*.epub 2>/dev/null | wc -l | xargs)
      echo "Loaded $BOOK_COUNT test book(s)"
    fi
  fi

  # Deploy OpenRouter API key to simulator UserDefaults (survives app reinstall)
  if [ -n "${OPENROUTER_API_KEY:-}" ]; then
    echo "Deploying OpenRouter API key..."
    xcrun simctl spawn "$DEVICE_UDID" defaults write "$APP_BUNDLE_ID" OpenRouterAPIKey "$OPENROUTER_API_KEY"
  fi
else
  xcrun devicectl device install app --device "$DEVICE_UDID" "$APP_PATH" 2>&1 | grep -v "acquired" || true
fi

echo "Launching app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  # Screenshot mode - special headless launch
  if [ "$SCREENSHOT_MODE" = "1" ]; then
    if [ -z "$SCREENSHOT_BOOK" ]; then
      echo "Error: --book= is required for screenshot mode" >&2
      exit 1
    fi
    if [ -z "$SCREENSHOT_OUTPUT" ]; then
      echo "Error: --output= is required for screenshot mode" >&2
      exit 1
    fi

    # Build app arguments
    APP_ARGS="--screenshot-mode --screenshot-book=$SCREENSHOT_BOOK --screenshot-output=$SCREENSHOT_OUTPUT"
    if [ -n "$SCREENSHOT_CHAPTER" ]; then
      APP_ARGS="$APP_ARGS --screenshot-chapter=$SCREENSHOT_CHAPTER"
    fi
    if [ -n "$SCREENSHOT_CFI" ]; then
      APP_ARGS="$APP_ARGS --screenshot-cfi=$SCREENSHOT_CFI"
    fi
    if [ -n "$SCREENSHOT_RENDERER" ]; then
      APP_ARGS="$APP_ARGS --screenshot-renderer=$SCREENSHOT_RENDERER"
    fi
    if [ -n "$SCREENSHOT_FONT_SCALE" ]; then
      APP_ARGS="$APP_ARGS --screenshot-font-scale=$SCREENSHOT_FONT_SCALE"
    fi

    echo "Screenshot mode: book=$SCREENSHOT_BOOK output=$SCREENSHOT_OUTPUT"

    # Terminate any existing instance
    xcrun simctl terminate "$DEVICE_UDID" "$APP_BUNDLE_ID" 2>/dev/null || true

    # Launch with --console-pty to wait for app exit
    # shellcheck disable=SC2086
    xcrun simctl launch --console-pty "$DEVICE_UDID" "$APP_BUNDLE_ID" $APP_ARGS

    # Verify output file exists
    if [ -f "$SCREENSHOT_OUTPUT" ]; then
      echo "Screenshot saved: $SCREENSHOT_OUTPUT"
      exit 0
    else
      echo "Error: Screenshot file not found at $SCREENSHOT_OUTPUT" >&2
      exit 1
    fi
  fi

  # Normal launch mode
  xcrun simctl launch "$DEVICE_UDID" "$APP_BUNDLE_ID"
  echo ""
  echo "=== App Logs (com.splap.reader) ==="
  echo "Press Ctrl+C to stop"
  echo ""
  xcrun simctl spawn "$DEVICE_UDID" log stream --style compact --level debug --predicate 'subsystem == "com.splap.reader"' 2>/dev/null
else
  xcrun devicectl device process launch --device "$DEVICE_UDID" "$APP_BUNDLE_ID" --console
fi
