#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

# Use simulator by default, set USE_SIMULATOR=0 to use physical device
USE_SIMULATOR="${USE_SIMULATOR:-1}"

if [ "$USE_SIMULATOR" = "1" ]; then
  echo "Running on simulator..."
  DEVICE_NAME="iPad Pro 11-inch (M4)"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphonesimulator"

  # First check if any simulator is already booted
  DEVICE_UDID=$(xcrun simctl list devices | grep "(Booted)" | head -1 | \
    grep -o "[0-9A-F]\{8\}-[0-9A-F]\{4\}-[0-9A-F]\{4\}-[0-9A-F]\{4\}-[0-9A-F]\{12\}")

  if [ -n "$DEVICE_UDID" ]; then
    echo "Using already-booted simulator: $DEVICE_UDID"
  else
    # No simulator booted, find and boot iOS 26 iPad Pro 11-inch M4
    DEVICE_UDID=$(python3 - <<'PY'
import json
import subprocess
import sys

name = "iPad Pro 11-inch (M4)"

raw = subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"])
obj = json.loads(raw)
# Look for iOS 26 runtime
for runtime, devices in obj.get("devices", {}).items():
    if "iOS-26" in runtime or "iOS-18-2" in runtime:
        for device in devices:
            if device.get("name") == name:
                print(device.get("udid", ""))
                sys.exit(0)

sys.exit(1)
PY
)

    if [ -z "$DEVICE_UDID" ]; then
      echo "Simulator device not found for $DEVICE_NAME with iOS 26." >&2
      exit 1
    fi

    echo "Booting simulator: $DEVICE_UDID"
    xcrun simctl boot "$DEVICE_UDID" || true
    xcrun simctl bootstatus "$DEVICE_UDID" -b
  fi
else
  echo "Running on physical iPad..."
  # Find first connected iOS device
  DEVICE_UDID=$(xcrun devicectl list devices 2>/dev/null | grep -E "^[0-9A-F-]+" | head -1 | awk '{print $1}')
  if [ -z "$DEVICE_UDID" ]; then
    echo "No physical device found. Connect a device or use USE_SIMULATOR=1" >&2
    exit 1
  fi
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphoneos"
fi

# Build the app
echo "Building for $SDK..."
if [ "$USE_SIMULATOR" = "1" ]; then
  PLATFORM="iOS Simulator"
else
  PLATFORM="iOS"
fi

DERIVED_DATA="$ROOT_DIR/.build/DerivedData"

xcodebuild \
  -scheme ReaderApp \
  -destination "platform=$PLATFORM,id=$DEVICE_UDID" \
  -derivedDataPath "$DERIVED_DATA" \
  -allowProvisioningUpdates \
  -quiet \
  build

APP_PATH="$DERIVED_DATA/Build/Products/Debug-$SDK/ReaderApp.app"

if [ ! -d "$APP_PATH" ]; then
  echo "App not found at $APP_PATH. Build failed?" >&2
  exit 1
fi

echo "Installing app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

  # Load test books if available (set TEST_BOOKS_DIR to your epub directory)
  BOOKS_SOURCE="${TEST_BOOKS_DIR:-}"
  if [ -n "$BOOKS_SOURCE" ] && [ -d "$BOOKS_SOURCE" ]; then
    echo "Loading test books..."
    APP_CONTAINER=$(xcrun simctl get_app_container "$DEVICE_UDID" "$APP_BUNDLE_ID" data 2>/dev/null || true)
    if [ -n "$APP_CONTAINER" ]; then
      BOOKS_DIR="$APP_CONTAINER/Documents/TestBooks"
      mkdir -p "$BOOKS_DIR"
      cp "$BOOKS_SOURCE"/*.epub "$BOOKS_DIR/" 2>/dev/null || true
      BOOK_COUNT=$(ls "$BOOKS_DIR"/*.epub 2>/dev/null | wc -l | xargs)
      echo "Loaded $BOOK_COUNT test book(s)"
    fi
  fi
else
  xcrun devicectl device install app --device "$DEVICE_UDID" "$APP_PATH" 2>&1 | grep -v "acquired" || true
fi

echo "Launching app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl launch "$DEVICE_UDID" "$APP_BUNDLE_ID"
  echo ""
  echo "=== App Logs (com.splap.reader) ==="
  echo "Press Ctrl+C to stop"
  echo ""
  xcrun simctl spawn "$DEVICE_UDID" log stream --style compact --level debug --predicate 'subsystem == "com.splap.reader"' 2>/dev/null
else
  xcrun devicectl device process launch --device "$DEVICE_UDID" "$APP_BUNDLE_ID" --console
fi
