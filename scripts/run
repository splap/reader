#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

# Use physical iPad by default, set USE_SIMULATOR=1 to use simulator
USE_SIMULATOR="${USE_SIMULATOR:-0}"

if [ "$USE_SIMULATOR" = "1" ]; then
  echo "Running on simulator..."
  DEVICE_NAME="iPad Pro 11-inch (M4)"
  RUNTIME_ID="com.apple.CoreSimulator.SimRuntime.iOS-18-5"
  APP_BUNDLE_ID="com.example.reader"
  SDK="iphonesimulator"

  DEVICE_UDID=$(python3 - <<'PY'
import json
import subprocess
import sys

runtime_id = "com.apple.CoreSimulator.SimRuntime.iOS-18-5"
name = "iPad Pro 11-inch (M4)"

raw = subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"])
obj = json.loads(raw)
for device in obj.get("devices", {}).get(runtime_id, []):
    if device.get("name") == name:
        print(device.get("udid", ""))
        sys.exit(0)

sys.exit(1)
PY
)

  if [ -z "$DEVICE_UDID" ]; then
    echo "Simulator device not found for $DEVICE_NAME ($RUNTIME_ID)." >&2
    exit 1
  fi

  xcrun simctl boot "$DEVICE_UDID" || true
  xcrun simctl bootstatus "$DEVICE_UDID" -b
else
  echo "Running on physical iPad..."
  DEVICE_UDID="00008027-0009043A2687002E"
  APP_BUNDLE_ID="com.splap.reader"
  SDK="iphoneos"
fi

# Build the app
echo "Building for $SDK..."
xcodebuild \
  -scheme ReaderApp \
  -destination "platform=iOS,id=$DEVICE_UDID" \
  -allowProvisioningUpdates \
  -quiet \
  build

APP_PATH="$HOME/Library/Developer/Xcode/DerivedData/Reader-bbwykgehugzyzdamvzcflakzkgju/Build/Products/Debug-$SDK/ReaderApp.app"

if [ ! -d "$APP_PATH" ]; then
  echo "App not found at $APP_PATH. Build failed?" >&2
  exit 1
fi

echo "Installing app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl install "$DEVICE_UDID" "$APP_PATH"
else
  xcrun devicectl device install app --device "$DEVICE_UDID" "$APP_PATH" 2>&1 | grep -v "acquired" || true
fi

echo "Launching app..."
if [ "$USE_SIMULATOR" = "1" ]; then
  xcrun simctl launch "$DEVICE_UDID" "$APP_BUNDLE_ID"
else
  xcrun devicectl device process launch --device "$DEVICE_UDID" "$APP_BUNDLE_ID" --console
fi
