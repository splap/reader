#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

# Load local environment from .env
if [ -f "$ROOT_DIR/.env" ]; then
  set -a  # auto-export all variables
  source "$ROOT_DIR/.env"
  set +a
else
  echo "Warning: No .env file found."
  echo "  Copy .env.example to .env and configure for your environment."
  echo "  Required for device builds: DEVELOPMENT_TEAM"
  echo ""
fi

# Default DEVELOPMENT_TEAM to empty for simulator-only builds
export DEVELOPMENT_TEAM="${DEVELOPMENT_TEAM:-}"

# Install mint if needed
if ! command -v mint >/dev/null 2>&1; then
  if command -v brew >/dev/null 2>&1; then
    brew install mint
  else
    echo "mint not found and Homebrew is missing. Install Mint and retry." >&2
    exit 1
  fi
fi

# Install swiftlint via brew (faster than mint, no GitHub auth issues)
if ! command -v swiftlint >/dev/null 2>&1; then
  brew install swiftlint
fi

# Generate embedding model if missing (required for semantic search)
ML_MODEL_PATH="$ROOT_DIR/App/Resources/bge-small-en.mlpackage"
if [ ! -d "$ML_MODEL_PATH" ]; then
  echo "Embedding model not found, generating..."
  uv run --with "transformers<5" --with "torch>=2.7,<2.8" --with coremltools --with "numpy<2" --with scipy \
    python "$ROOT_DIR/scripts/convert_bge_to_coreml.py"
fi

mint bootstrap
mint run xcodegen generate --spec project.yml
